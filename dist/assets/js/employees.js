/**
 * INGENZI HRMS - Employee Management Module
 * Uses Backend API instead of IndexedDB
 */

let currentEditId = null;

document.addEventListener('DOMContentLoaded', async function() {
  if (!window.API) {
    console.error('API service not available');
    return;
  }
  await loadEmployees();
  setupEventListeners();
});

function setupEventListeners() {
  const addBtn = document.getElementById('addEmployeeBtn');
  if (addBtn) {
    addBtn.addEventListener('click', showAddEmployeeModal);
  }

  const employeeForm = document.getElementById('employeeForm');
  if (employeeForm) {
    employeeForm.addEventListener('submit', handleEmployeeSubmit);
  }

  const closeModal = document.getElementById('closeEmployeeModal');
  if (closeModal) {
    closeModal.addEventListener('click', closeEmployeeModal);
  }
}

async function loadEmployees() {
  const userRole = getCurrentUserRole();
  
  if (userRole === 'employee') {
    window.location.href = '../dashboard/index.html';
    return;
  }

  try {
    const employees = await window.API.getEmployees();
    const departments = await window.API.getDepartments();
    const tbody = document.getElementById('employeesTableBody');
    
    if (!tbody) return;

    if (employees.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-muted">No employees found. Click "Add Employee" to get started.</td></tr>';
      return;
    }

    tbody.innerHTML = employees.map(emp => {
      const dept = departments.find(d => d.id === emp.departmentId);
      return `
        <tr>
          <td>${emp.employeeId}</td>
          <td>${emp.firstName} ${emp.lastName}</td>
          <td>${dept ? dept.name : 'N/A'}</td>
          <td>${emp.position}</td>
          <td>${emp.email}</td>
          <td>
            <span class="badge ${emp.status === 'active' ? 'bg-success-500' : 'bg-danger-500'}">${emp.status}</span>
          </td>
          <td>
            <button class="btn btn-sm btn-primary" onclick="viewEmployee(${emp.id})">View</button>
            <button class="btn btn-sm btn-secondary" onclick="editEmployee(${emp.id})">Edit</button>
            <button class="btn btn-sm btn-danger" onclick="deleteEmployee(${emp.id})">Delete</button>
          </td>
        </tr>
      `;
    }).join('');
  } catch (error) {
    console.error('Error loading employees:', error);
    const tbody = document.getElementById('employeesTableBody');
    if (tbody) {
      tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-danger">Error loading employees. Please refresh the page.</td></tr>';
    }
  }
}

async function showAddEmployeeModal() {
  currentEditId = null;
  const modal = document.getElementById('employeeModal');
  const form = document.getElementById('employeeForm');
  const modalTitle = document.getElementById('employeeModalTitle');
  
  if (modalTitle) modalTitle.textContent = 'Add Employee';
  if (form) form.reset();
  
  // Employee ID will be auto-generated by backend
  const employeeIdInput = document.getElementById('employeeId');
  if (employeeIdInput) {
    employeeIdInput.value = '';
    employeeIdInput.disabled = true;
    employeeIdInput.placeholder = 'Auto-generated';
  }
  
  // Show password and role fields when adding
  const passwordInput = document.getElementById('password');
  const roleInput = document.getElementById('role');
  if (passwordInput) {
    passwordInput.closest('.col-span-12')?.style.setProperty('display', 'block');
  }
  if (roleInput) {
    roleInput.closest('.col-span-12')?.style.setProperty('display', 'block');
    roleInput.value = 'employee'; // Default role
  }
  
  // Set default status
  const statusInput = document.getElementById('status');
  if (statusInput) {
    statusInput.value = 'active';
  }
  
  // Set today's date as default hire date
  const hireDateInput = document.getElementById('hireDate');
  if (hireDateInput) {
    hireDateInput.value = new Date().toISOString().split('T')[0];
  }
  
  await loadDepartmentsDropdown();
  
  if (modal) modal.style.display = 'block';
}

async function editEmployee(id) {
  try {
    currentEditId = id;
    const employee = await window.API.getEmployee(id);
    if (!employee) return;

    const modal = document.getElementById('employeeModal');
    const form = document.getElementById('employeeForm');
    const modalTitle = document.getElementById('employeeModalTitle');
    
    if (modalTitle) modalTitle.textContent = 'Edit Employee';
    
    if (form) {
      const employeeIdInput = document.getElementById('employeeId');
      if (employeeIdInput) {
        employeeIdInput.value = employee.employeeId;
        employeeIdInput.disabled = true;
      }
      document.getElementById('firstName').value = employee.firstName || '';
      document.getElementById('lastName').value = employee.lastName || '';
      document.getElementById('email').value = employee.email || '';
      document.getElementById('phone').value = employee.phone || '';
      document.getElementById('departmentId').value = employee.departmentId || '';
      document.getElementById('position').value = employee.position || '';
      document.getElementById('salary').value = employee.salary || '';
      document.getElementById('hireDate').value = employee.hireDate ? employee.hireDate.split('T')[0] : '';
      document.getElementById('status').value = employee.status || 'active';
      document.getElementById('address').value = employee.address || '';
      
      // Hide password and role fields when editing (can't change these)
      const passwordInput = document.getElementById('password');
      const roleInput = document.getElementById('role');
      if (passwordInput) {
        passwordInput.closest('.col-span-12')?.style.setProperty('display', 'none');
        passwordInput.value = '';
      }
      if (roleInput) {
        roleInput.closest('.col-span-12')?.style.setProperty('display', 'none');
      }
    }
    
    await loadDepartmentsDropdown();
    
    if (modal) modal.style.display = 'block';
  } catch (error) {
    console.error('Error loading employee:', error);
    showNotification('Error loading employee details', 'error');
  }
}

async function viewEmployee(id) {
  try {
    const employee = await window.API.getEmployee(id);
    if (!employee) return;

    const dept = employee.department ? employee.department : 
                 await window.API.getDepartment(employee.departmentId);
    
    const salary = typeof employee.salary === 'number' ? employee.salary : parseFloat(employee.salary.toString());
    const formattedSalary = salary ? `RWF ${salary.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` : 'N/A';
    
    const details = `Name: ${employee.firstName} ${employee.lastName}\nEmail: ${employee.email}\nPosition: ${employee.position}\nDepartment: ${dept ? dept.name : 'N/A'}\nSalary: ${formattedSalary}`;
    await showAlert(details, 'Employee Details', 'info');
  } catch (error) {
    console.error('Error viewing employee:', error);
    showNotification('Error loading employee details', 'error');
  }
}

async function deleteEmployee(id) {
  const confirmed = await showConfirm(
    'Are you sure you want to delete this employee? This action cannot be undone.',
    'Delete Employee',
    'Delete',
    'Cancel'
  );
  if (!confirmed) return;
  
  try {
    await window.API.deleteEmployee(id);
    await loadEmployees();
    showNotification('Employee deleted successfully', 'success');
  } catch (error) {
    console.error('Error deleting employee:', error);
    showNotification(error.message || 'Error deleting employee', 'error');
  }
}

async function handleEmployeeSubmit(e) {
  e.preventDefault();
  
  const formData = {
    firstName: document.getElementById('firstName').value.trim(),
    lastName: document.getElementById('lastName').value.trim(),
    email: document.getElementById('email').value.trim().toLowerCase(),
    phone: document.getElementById('phone').value.trim() || null,
    departmentId: parseInt(document.getElementById('departmentId').value),
    position: document.getElementById('position').value.trim(),
    salary: parseFloat(document.getElementById('salary').value),
    hireDate: document.getElementById('hireDate').value,
    status: document.getElementById('status').value,
    address: document.getElementById('address').value.trim() || null
  };

  // Optional employeeId (will be auto-generated if not provided)
  const employeeIdInput = document.getElementById('employeeId');
  if (employeeIdInput && employeeIdInput.value) {
    formData.employeeId = employeeIdInput.value.trim();
  }

  // Password and role (only for new employees)
  if (!currentEditId) {
    const passwordInput = document.getElementById('password');
    const roleInput = document.getElementById('role');
    
    if (passwordInput && passwordInput.value.trim()) {
      const password = passwordInput.value.trim();
      if (password.length < 6) {
        showNotification('Password must be at least 6 characters long', 'error');
        return;
      }
      formData.password = password;
      
      if (roleInput) {
        formData.role = roleInput.value;
      }
    }
  }

  // Validate required fields
  if (!formData.firstName || !formData.lastName || !formData.email || !formData.departmentId || !formData.position || !formData.salary || !formData.hireDate) {
    showNotification('Please fill in all required fields', 'error');
    return;
  }

  try {
    if (currentEditId) {
      // Remove password and role from update (those can't be changed here)
      delete formData.password;
      delete formData.role;
      await window.API.updateEmployee(currentEditId, formData);
      showNotification('Employee updated successfully', 'success');
    } else {
      await window.API.createEmployee(formData);
      showNotification('Employee added successfully', 'success');
    }

    closeEmployeeModal();
    await loadEmployees();
  } catch (error) {
    console.error('Error saving employee:', error);
    const errorMessage = error.message || 'Error saving employee';
    showNotification(errorMessage, 'error');
    if (window.Toast) {
      window.Toast.error(errorMessage);
    }
  }
}

function closeEmployeeModal() {
  const modal = document.getElementById('employeeModal');
  if (modal) modal.style.display = 'none';
  currentEditId = null;
  const form = document.getElementById('employeeForm');
  if (form) form.reset();
}

async function loadDepartmentsDropdown() {
  try {
    const departments = await window.API.getDepartments();
    const select = document.getElementById('departmentId');
    if (!select) return;

    select.innerHTML = '<option value="">Select Department</option>' +
      departments.map(dept => 
        `<option value="${dept.id}">${dept.name}</option>`
      ).join('');
  } catch (error) {
    console.error('Error loading departments:', error);
  }
}

function showNotification(message, type) {
  const notification = document.createElement('div');
  notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} fixed top-4 right-4 z-50`;
  notification.textContent = message;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.remove();
  }, 3000);
}

// Make functions global for onclick handlers
window.viewEmployee = viewEmployee;
window.editEmployee = editEmployee;
window.deleteEmployee = deleteEmployee;
